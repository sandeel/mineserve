---
AWSTemplateFormatVersion: '2010-09-09'

Parameters: 
  KeyName: 
    Description: Amazon EC2 Key Pair
    Type: "AWS::EC2::KeyPair::KeyName"

Resources:
  Vpc:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: 'true'
      EnableDnsHostnames: 'true'

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId:
        Ref: Vpc
      CidrBlock: 10.0.0.0/24
      Tags:
        - Key: Name
          Value: PublicSubnet
      MapPublicIpOnLaunch: 'true'

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId:
        Ref: Vpc
      InternetGatewayId:
        Ref: InternetGateway

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId:
        Ref: Vpc

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId:
        Ref: PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId:
        Ref: InternetGateway

  mySubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId:
        Ref: PublicSubnet
      RouteTableId:
        Ref: PublicRouteTable

  taskdefinition: 
    Type: "AWS::ECS::TaskDefinition"
    Properties: 
      Family: "msv"
      Volumes: 
      - 
        Host: 
          SourcePath: "/home/ec2-user/users.conf"
        Name: "sftpconfig"
      - 
        Host: 
          SourcePath: "/home/ec2-user/server.properties"
        Name: "server-properties"
      - 
        Host: 
          SourcePath: "/plugins"
        Name: "plugins"
      ContainerDefinitions: 
      - 
        Name: "pmmp"
        Image: "297089873106.dkr.ecr.eu-west-1.amazonaws.com/pmmp:latest"
        PortMappings:
          - 
            ContainerPort: 19132
            HostPort: 19132
            Protocol: tcp
          -
            ContainerPort: 19132
            HostPort: 19132
            Protocol: udp
          - 
            ContainerPort: 9090
            HostPort: 9090
            Protocol: tcp
        Essential: "true"
        Memory: 6144
        MountPoints: 
        - 
          SourceVolume: "plugins"
          ContainerPath: "/pocketmine/plugins"
        - 
          SourceVolume: "server-properties"
          ContainerPath: "/pocketmine/server.properties"
      - 
        Name: "ftp"
        Image: "atmoz/sftp"
        PortMappings:
          - 
            ContainerPort: 22
            HostPort: 2222
            Protocol: tcp
        Essential: "true"
        Memory: 512
        MountPoints: 
        - 
          SourceVolume: "sftpconfig"
          ContainerPath: "/etc/sftp-users.conf"
        - 
          SourceVolume: "plugins"
          ContainerPath: "/home/user/plugins"

  sshSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow SSH
      VpcId:
        Ref: Vpc

  sshSGInboundRuleSSH:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: '22'
      ToPort: '22'
      CidrIp: 0.0.0.0/0
      GroupId:
        Fn::GetAtt:
        - sshSG
        - GroupId

  ContainerAgentSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: For container agents
      VpcId:
        Ref: Vpc

  ContainerAgentInboundRulePmmpTcp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: '19132'
      ToPort: '19132'
      CidrIp: 0.0.0.0/0
      GroupId:
        Fn::GetAtt:
        - ContainerAgentSG
        - GroupId

  ContainerAgentInboundRulePmmpUdp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: udp
      FromPort: '19132'
      ToPort: '19132'
      CidrIp: 0.0.0.0/0
      GroupId:
        Fn::GetAtt:
        - ContainerAgentSG
        - GroupId

  ContainerAgentInboundRuleDestionationUnreachable:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: 'icmp'
      FromPort: '3'
      ToPort: '3'
      CidrIp: 0.0.0.0/0
      GroupId:
        Fn::GetAtt:
        - ContainerAgentSG
        - GroupId

  ContainerAgentInboundRulePocketDockConsole:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: '9090'
      ToPort: '9090'
      CidrIp: 0.0.0.0/0
      GroupId:
        Fn::GetAtt:
        - ContainerAgentSG
        - GroupId

  ContainerAgentInboundRuleSftp:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: '2222'
      ToPort: '2222'
      CidrIp: 0.0.0.0/0
      GroupId:
        Fn::GetAtt:
        - ContainerAgentSG
        - GroupId

  GitRepo:
    Type: "AWS::CodeCommit::Repository"
    Properties: 
      RepositoryDescription: "msv"
      RepositoryName: "msv"

  ResourcesBucket:
    Type: AWS::S3::Bucket

Mappings: 
  RegionMap: 
    us-east-1: 
      AMI: "ami-6411e20d"
    us-west-1: 
      AMI: "ami-9398d3e0"
    eu-west-1: 
      amazon: "ami-9398d3e0"
      ubuntu: "ami-0d77397e"
      ecsoptimized: "ami-a1491ad2"
    ap-southeast-1: 
      AMI: "ami-66f28c34"
    ap-northeast-1: 
      AMI: "ami-9c03a89d"
